<!--
  ~ Copyright (C) 2017 - 2019 DataSwift Ltd - All Rights Reserved
  ~ This Source Code Form is subject to the terms of the Mozilla Public
  ~ License, v. 2.0. If a copy of the MPL was not distributed with this
  ~ file, You can obtain one at http://mozilla.org/MPL/2.0/.
  ~ Written by Augustinas Markevicius <augustinas.markevicius@dataswift.io> 4, 2017
  -->

<ng-container *ngIf="hatApp || errorMessage else loading">
  <ng-container *ngIf="hatApp">
    <div class="content-wrapper">
      <section class="drp-explainer">
        <h3 class="section-heading" style="margin: 32px auto;">{{hatAddress}}</h3>

        <ng-container *ngIf="hatExists; else hatNotExists">
          <p class="section-text">Our friends at {{hatApp.application.developer.name}} have requested access to your Personal Data Account with the above URL.</p>
        </ng-container>

        <ng-template #hatNotExists>
          <p class="section-text">Our friends at {{hatApp.application.developer.name}} have requested for a Personal Data Account
            to be created with the above URL. Check your email for more details.</p>
        </ng-template>
      </section>

      <div class="section-divider"></div>

      <div class="drp-logo-wrapper">
        <img src="/assets/images/HATDataRights_200.png" class="drp-logo" height="100" width="100" alt="HAT Data rights"/>
      </div>

      <section class="permissions-section" *ngIf="dependencyApps && dependencyApps.length > 0">
        <h3 class="section-heading">Setting up the data plug</h3>
        <p class="section-text">The data plug enables you to copy data from different places on the internet into your HAT PDA.</p>

        <mat-card *ngFor="let depApp of dependencyApps">
          <div class="app-card-img-wrapper" [style.background-color]="depApp.application.info.primaryColor">
            <img src="/assets/images/data-plug-lego-icon.png" alt="Data plug"/>
          </div>

          <mat-card-content>
            <h5 class="card-heading">{{depApp.application.info.name}}</h5>
          </mat-card-content>
        </mat-card>
      </section>

      <ng-container *ngIf="hatApp.application.setup.dependencies || (hatApp.application.permissions.dataRequired && hatApp.application.permissions.dataRequired.bundle)">
        <section class="permissions-section" style="text-align: center;">
          <p class="section-text">The app and the data plug will have permission to take actions in your HAT.</p>
          <button role="button" class="link-button" (click)="handleShowPermissions()">Review permissions.</button>
        </section>
      </ng-container>

      <section class="permissions-section">
        <div class="hmi-data-share-wrapper">
          <img class="data-share-icon" src="/assets/images/data-share.svg" alt="data share" />
          <img class="data-share-logo" [src]="hatApp.application.info.graphics.logo.normal" alt="data share" />
        </div>
        <h3 class="section-heading">Your data will be shared with {{hatApp.application.info.name}}</h3>

        <p class="section-text">You are giving the app permission to:</p>

        <div class="data-access-summary" *ngIf="hatApp.application.permissions.dataRequired && hatApp.application.permissions.dataRequired.bundle">
          <mat-expansion-panel>
            <mat-expansion-panel-header>
              <mat-panel-title class="expandable-card-title">Use your data</mat-panel-title>
            </mat-expansion-panel-header>

            <mat-panel-description class="hmi-data-debit-panel-description">
              <div>The app will be able to use the following:</div> <br />
              <div *ngFor="let endpoint of hatApp.application.permissions.dataRequired.bundle.bundle | unbundle">
                <div>
                  <div>
                    {{endpoint.title}} data
                  </div>
                  <ul class="card-list">
                    <li *ngFor="let field of endpoint.fields">{{field}}</li>
                  </ul>
                </div>
              </div>
            </mat-panel-description>
          </mat-expansion-panel>
        </div>

        <mat-card>
          <ng-container *ngIf="hatApp.application.setup.dependencies || (hatApp.application.permissions.dataRequired && hatApp.application.permissions.dataRequired.bundle); else noExtraDataPermissions">
            <mat-card-content>
              <h5 class="card-heading">Purpose of data usage</h5>
              <p class="card-text">{{hatApp.application.info.dataUsePurpose}}</p>
            </mat-card-content>
          </ng-container>

          <ng-template #noExtraDataPermissions>
            <mat-card-content>
              <h5 class="card-heading">Take actions in your HAT</h5>
              <rum-hat-app-hmi-content [appContent]="hatApp.application"></rum-hat-app-hmi-content>
            </mat-card-content>
          </ng-template>
        </mat-card>
      </section>

      <section class="permissions-section" *ngIf="hatApp.application.info.rating">
        <h3 class="section-heading">Make sure you trust App</h3>
        <p class="section-text">
          Find out how {{hatApp.application.info.name}} will handle your data
          by reviewing its terms of service and privacy policies. You can always view this contract and remove access to this app in your HAT App Settings under Data Debits.
        </p>

        <div class="app-logo-container">
          <div class="app-logo-wrapper">
            <img [src]="hatApp.application.info.graphics.logo.normal" alt="Application logo" class="img img-responsive app-logo" />
          </div>

          <div class="app-rating-wrapper">
            <div class="app-rating">
              <span class="app-rating-highlighted">{{hatApp.application.info.rating.score}}</span>
            </div>
          </div>

          <div class="app-details-header-headline">
            This app is rated {{hatApp.application.info.rating.score}}
          </div>
          <a href="https://www.hatcommunity.org/hat-dex-rating" target="_blank" class="app-link" rel="noopener noreferrer">Learn more</a>
        </div>
      </section>
    </div>


    <div class="sticky-action-panel">
      <div class="sticky-action-panel-content">
        <div class="action-buttons">
          <button mat-flat-button role="button" (click)="declineTerms()" class="secondary-action">Cancel</button>
          <button mat-flat-button role="button" (click)="agreeTerms(hatApp.application.id)" class="primary-action">Confirm</button>
        </div>
        <p class="hmi-id-text">HMI ID: {{hatApp.application.id}}-v{{hatApp.application.info.version}}</p>
        <p class="tos-text">By pressing ‘Confirm’ I agree to Dataswift Ltd
          <a href="https://cdn.dataswift.io/legal/dataswift-privacy-policy.pdf" target="_blank" style="color: #6297b1;">Privacy Policy</a>
          and the HAT
          <a href="https://cdn.dataswift.io/legal/hat-owner-terms-of-service.pdf" target="_blank" style="color: #6297b1;">Terms of Service</a>
          </p>
      </div>
    </div>
  </ng-container>

  <ng-container *ngIf="errorMessage">
    <div class="app-error">
      <h3 class="app-error-header">Ooops... Looks like something went wrong.</h3>
      <p class="app-error-text">{{errorMessage}}</p>
    </div>
  </ng-container>

</ng-container>

<ng-template #loading>
  <div class="loading">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading permissions</div>
  </div>
</ng-template>
